#!/bin/sh
#
#  (c) 2018-2020 m4r35n357@gmail.com (Ian Smith), for licencing see the LICENCE file
#
#  Example: time -p ./bifurcation-scan .01 .35 10 ./tsm-thomas-static 6 10 0.1 10000 1 0 0 '$p'
#  Example: gnuplot -p -e "set terminal wxt size 1350,800; set grid back; plot '<cat' with dots" </tmp/bifurcationX
#  Example: gnuplot -p -e "set terminal png size 1350,800; set grid back; plot '<cat' with dots" </tmp/bifurcationX >X.png
#

echo "Bifurcation Diagrams: [$*]" >&2

start=$1
end=$2
skip=$3
step=$(echo "scale=15; ($end - $start) / 1501;" | /usr/bin/bc)
shift 3
datalines=$5
command=$*

tmpfile='/tmp/data'
filtered='/tmp/bifurcation'
>${filtered}X
>${filtered}Y
>${filtered}Z

[ $skip -eq 0 ] && lower=1 || lower=$((datalines / skip + 1))
upper=$((datalines + 1))

p=${start}
while [ $(echo "$p < $end" | /usr/bin/bc) -eq 1 ]
do
    eval ${command} 2>/dev/null | /bin/sed --quiet "$lower,$ p" >${tmpfile}
    if [ $(/usr/bin/wc --lines <$tmpfile) -eq $((upper - lower + 1)) ]
    then
        echo "   Processing parameter value: $p" >&2
        /bin/grep 'X' ${tmpfile} | sed --expression="s/\([^ ]*\) *\([^ ]*\) *\([^ ]*\) *.*/$p \1/" >>${filtered}X &
        /bin/grep 'Y' ${tmpfile} | sed --expression="s/\([^ ]*\) *\([^ ]*\) *\([^ ]*\) *.*/$p \2/" >>${filtered}Y &
        /bin/grep 'Z' ${tmpfile} | sed --expression="s/\([^ ]*\) *\([^ ]*\) *\([^ ]*\) *.*/$p \3/" >>${filtered}Z &
        wait
    else
        echo "UNBOUNDED for parameter value: $p" >&2
    fi
    p=$(echo "$p + $step;" | /usr/bin/bc)
done
