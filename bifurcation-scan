#!/bin/sh
#
#  (c) 2018-2020 m4r35n357@gmail.com (Ian Smith), for licencing see the LICENCE file
#

echo "Bifurcation Diagrams: [$*]" >&2

start=$1
end=$2
skip=$3
step=$(echo "scale=15; ($end - $start) / 1501;" | /usr/bin/bc)
shift 3
datalines=$5
command=$*

tmpdir=${TMP_TAYLOR:-/tmp/$USER}
tmpfile=${tmpdir}/data
filtered=${tmpdir}/bifurcation
for item in X x Y y Z z
do
    >${filtered}${item}
done

[ $skip -eq 0 ] && lower=1 || lower=$((datalines / skip + 1))
upper=$((datalines + 1))

p=${start}
while [ $(echo "$p < $end" | /usr/bin/bc) -eq 1 ]
do
    eval ${command} 2>/dev/null | /bin/sed --quiet "$lower,$ p" >${tmpfile}
    if [ $(/usr/bin/wc --lines <$tmpfile) -eq $((upper - lower + 1)) ]
    then
        echo "   Processing parameter value: $p"
        /bin/grep 'X' ${tmpfile} | /bin/sed --expression="s/\([^ ]*\) *\([^ ]*\) *\([^ ]*\) *.*/$p \1/" >>${filtered}X &
        /bin/grep 'x' ${tmpfile} | /bin/sed --expression="s/\([^ ]*\) *\([^ ]*\) *\([^ ]*\) *.*/$p \1/" >>${filtered}x &
        /bin/grep 'Y' ${tmpfile} | /bin/sed --expression="s/\([^ ]*\) *\([^ ]*\) *\([^ ]*\) *.*/$p \2/" >>${filtered}Y &
        /bin/grep 'y' ${tmpfile} | /bin/sed --expression="s/\([^ ]*\) *\([^ ]*\) *\([^ ]*\) *.*/$p \2/" >>${filtered}y &
        /bin/grep 'Z' ${tmpfile} | /bin/sed --expression="s/\([^ ]*\) *\([^ ]*\) *\([^ ]*\) *.*/$p \3/" >>${filtered}Z &
        /bin/grep 'z' ${tmpfile} | /bin/sed --expression="s/\([^ ]*\) *\([^ ]*\) *\([^ ]*\) *.*/$p \3/" >>${filtered}z &
        wait
    else
        echo "UNBOUNDED for parameter value: $p"
    fi
    p=$(echo "$p + $step;" | /usr/bin/bc)
done

base='set terminal png size 1350,800 background rgb "grey85"; set grid back;'
/usr/bin/gnuplot -e "set title '$*'; $base plot '${filtered}X' lt rgb '#000080' w dots, '${filtered}x' lt rgb '#004040' w dots" \
    >${tmpdir}/X.png &
/usr/bin/gnuplot -e "set title '$*'; $base plot '${filtered}Y' lt rgb '#008000' w dots, '${filtered}y' lt rgb '#404000' w dots" \
    >${tmpdir}/Y.png &
/usr/bin/gnuplot -e "set title '$*'; $base plot '${filtered}Z' lt rgb '#800000' w dots, '${filtered}z' lt rgb '#400040' w dots" \
    >${tmpdir}/Z.png &
wait
