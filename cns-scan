#!/bin/sh
#
#  (c) 2018-2023 m4r35n357@gmail.com (Ian Smith), for licencing see the LICENCE file

args="$0 $*"
echo "args: \033[1;37m$(($# + 1))\033[0;37m, [ \033[0;35m$args\033[0;37m ]" >&2

user_dir="/tmp/$USER"
[ ! -d $user_dir ] && mkdir $user_dir
user_data="$user_dir/data"

max=$1
threshold=$2
shift 2

case $4 in
    "_")  ;;
    *)    echo '"order" argument should be set to "_"'; exit 1;;
esac
timestep=$5
steps=$6

. ./cns-functions.sh

processed="$(get_precision $*)"
n=2
while [ $n -le $max ]
do
    set $processed
    begin="$1 $2 $3"
    shift 4
    current="$begin $n $*"
    halfstep $current
    $current >$fileB &
    wait
    temp=$(./divergence $fileA $fileB $threshold)
    case $temp in
        '') echo $n "Still within tolerance of $threshold - increase simulation time?"
            exit 1;;
         *) set $temp
            echo $n $4 $6;;
    esac
    n=$((n + 1))
done 2>/dev/null | tee $user_data

max_clean=$(echo "scale=2; $timestep * $steps;" | /usr/bin/bc)

set $(tail -1 $user_data)
max_cpu=$(echo "scale=2; 1.5 * $3;" | /usr/bin/bc)

 /usr/bin/gnuplot -p << EOF
set terminal wxt background rgb "grey85"
set title noenhanced '$args'
set key left
set ytics nomirror
set y2tics
set xlabel 'Taylor Series Order'
set ylabel 'Clean Simulation Time, model units'
set y2label 'CPU Time, seconds'
set style fill solid border -1
set xrange [0:]
set yrange [0:'$max_clean']
set y2range [0:'$max_cpu']
plot '$user_data' using 1:2 axes x1y1 title 'CNS' with boxes, '' u 1:3 axes x1y2 t 'CPU' w boxes
EOF
