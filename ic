#!/bin/sh
#
#  (c) 2018-2025 m4r35n357@gmail.com (Ian Smith), for licencing see the LICENCE file

echo "Sensitivity to Initial Conditions: [$0 $*]" >&2

tmpdir=${TMP_TAYLOR:-/tmp/$USER}
[ -d ${tmpdir} ] || mkdir ${tmpdir}
fileA=${tmpdir}/dataA
fileB=${tmpdir}/dataB
fileC=${tmpdir}/dataC
fileD=${tmpdir}/dataD
fileE=${tmpdir}/dataE
fileF=${tmpdir}/dataF
fileG=${tmpdir}/dataG

delta=$1
precision=$2
shift 2

perturb () {
    start="$1 $2 $3 $4 $5"
    x0=$6
    y0=$7
    z0=$8
    shift 8
    end="$*"
    echo 'oo' $start $x0 $y0 $z0 $end >&2
    $start $x0 $y0 $z0 $end >$fileG &
    y=$y0
    z=$z0
    x=$(echo "scale=$precision; $x0 + $delta;" | /usr/bin/bc)
    echo 'x+' $start $x $y $z $end >&2
    $start $x $y $z $end >$fileA &
    x=$(echo "scale=$precision; $x0 - $delta;" | /usr/bin/bc)
    echo 'x-' $start $x $y $z $end >&2
    $start $x $y $z $end >$fileB &
    x=$x0
    z=$z0
    y=$(echo "scale=$precision; $y0 + $delta;" | /usr/bin/bc)
    echo 'y+' $start $x $y $z $end >&2
    $start $x $y $z $end >$fileC &
    y=$(echo "scale=$precision; $y0 - $delta;" | /usr/bin/bc)
    echo 'y-' $start $x $y $z $end >&2
    $start $x $y $z $end >$fileD &
    x=$x0
    y=$y0
    z=$(echo "scale=$precision; $z0 + $delta;" | /usr/bin/bc)
    echo 'z+' $start $x $y $z $end >&2
    $start $x $y $z $end >$fileE &
    z=$(echo "scale=$precision; $z0 - $delta;" | /usr/bin/bc)
    echo 'z-' $start $x $y $z $end >&2
    $start $x $y $z $end >$fileF &
}

perturb $*
wait

./plot3d.py $fileA $fileB $fileC $fileD $fileE $fileF $fileG
