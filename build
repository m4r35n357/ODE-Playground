#!/bin/sh
#
# Example:  ./clean; time -p ./build
#
# Example:  for i in .5 0 -.5; do ./libad-test-dbg 32 20 $i 1e-12; done >/dev/null
#
#  (c) 2018-2022 m4r35n357@gmail.com (Ian Smith), for licencing see the LICENCE file

/usr/bin/ctags *.h *.c

WARNINGS='-pedantic -Wall -Wshadow -Wpointer-arith -Wcast-qual -Wstrict-prototypes -Wmissing-prototypes -Wextra -Wconversion -Wredundant-decls -Wmissing-field-initializers -Wmissing-declarations -Wuninitialized'

STD='c99'

case $1 in
    clang) WARNINGS="$WARNINGS -ffp-model=precise"
           CC="/usr/bin/clang -std=$STD";;
    gcc|*) WARNINGS="$WARNINGS -Wunsuffixed-float-constants -frounding-math -fsignaling-nans"
           CC="/usr/bin/gcc -std=$STD";;
esac
${CC} --version

rm -f *.o *.so *.gch

build () {
    name=$1
    echo " Building $name"
    ${CC} -O3 -DNDEBUG -o ${name}-dynamic ${name}.c taylor-ode.c main.c -lmpfr -s
    ${CC} -O3 -DNDEBUG -static -o ${name}-static ${name}.c taylor-ode.c main.c -lmpfr -lgmp -s
    ${CC} -O0 $WARNINGS -g -o ${name}-dbg ${name}.c taylor-ode.c main.c -lmpfr
}

for model in \
tsm-bouali \
tsm-burke-shaw \
tsm-genesio-tesi \
tsm-halvorsen \
tsm-isuc \
tsm-lorenz \
tsm-rf \
tsm-rossler \
tsm-rucklidge \
tsm-sj \
tsm-sprott-minimal \
tsm-sprott-thomas \
tsm-thomas \
tsm-wimol-banlue \
tsm-yu-wang
do
    rm -f ${model}-*
    build ${model} &
done

echo ""
echo " Building divergence"
${CC} -O3 $WARNINGS -o divergence divergence.c -lm -s &

echo " Building libad-test-dbg"
rm -f libad-test-dbg
${CC} -O0 $WARNINGS -g -o libad-test-dbg taylor-ode.c ad.c libad-test.c -lmpfr &

echo " Building libtaylor"
rm -f libtaylor.so taylor-ode.o
${CC} -O3 -DNDEBUG -c $WARNINGS -fpic taylor-ode.c && ${CC} -shared -o libtaylor.so taylor-ode.o -s &
# Example:
# gcc -O3 -DNDEBUG -L. -Wall -o test tsm-lorenz.c -ltaylor -lmpfr -s
# export LD_LIBRARY_PATH=.
# ./test 15 16 10 .01 10000 -15.8 -17.48 35.64 10 28 8 3 >/tmp/data; gnuplot -p -e "splot '/tmp/data' with lines"

wait

echo ""
ls -lh --color *ad-* tsm-* lib*.so divergence
