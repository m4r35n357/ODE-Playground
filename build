#!/bin/sh

# Copyright (c) 2018-2020, Ian Smith (m4r35n357)
# All rights reserved.
# For licencing see LICENCE file

WARNINGS='-pedantic -Wall -Wshadow -Wpointer-arith -Wcast-qual -Wstrict-prototypes -Wmissing-prototypes -Wextra'

CC='/usr/bin/c99'
if [ x"$1" = x'clang' ]
then
    CC='/usr/bin/clang'
fi
${CC} --version

rm -f *.o *.so *.gch

build () {
    name=$1
    ${CC} -O3 -DNDEBUG -o ${name}-dynamic ${name}.c taylor-ode.c -lmpfr -s
    ${CC} -O3 -DNDEBUG -static -o ${name}-static ${name}.c taylor-ode.c -lmpfr -lgmp -s
    ${CC} -O0 $WARNINGS -g -o ${name}-dbg ${name}.c taylor-ode.c -lmpfr
}

for model in \
tsm-double-pendulum \
rk4-lorenz \
tsm-lorenz \
tsm-rossler \
tsm-yu-wang \
tsm-genesio-tesi \
tsm-rucklidge \
tsm-halvorsen \
tsm-bouali \
tsm-rf \
tsm-wimol-banlue \
tsm-thomas \
tsm-sprott-minimal \
tsm-sprott-thomas \
tsm-sj \
tsm-lotka-volterra \
tsm-logistic \
tsm-constant
do
    rm -f ${model}-dynamic ${model}-static ${model}-dbg
    build ${model} &
done

rm -f ad-test-dbg
${CC} -O0 $WARNINGS -g -o ad-test-dbg taylor-ode.c ad.c ad-test.c -lmpfr &
#${CC} -O0 $WARNINGS -fprofile-arcs -ftest-coverage -g -o ad-test-dbg taylor-ode.c ad.c ad-test.c -lmpfr &
rm -f libad-test-dbg
${CC} -O0 $WARNINGS -g -o libad-test-dbg taylor-ode.c ad.c libad-test.c -lmpfr &
#${CC} -O0 $WARNINGS -fprofile-arcs -ftest-coverage -g -o libad-test-dbg taylor-ode.c ad.c libad-test.c -lmpfr &
rm -f ad-newton-dbg
${CC} -O0 $WARNINGS -g -o ad-newton-dbg taylor-ode.c ad.c ad-newton.c -lmpfr &

rm -f libtaylor.so taylor-ode.o
${CC} -O0 -c $WARNINGS -g -fpic taylor-ode.c && ${CC} -shared -o libtaylor.so taylor-ode.o &
# Example:
# gcc -L. -Wall -g -o test tsm-lorenz.c -ltaylor -lmpfr
# ./test 16 10 .01 10000 -15.8 -17.48 35.64 10 28 8 3 >/tmp/data; echo "splot '/tmp/data' with lines" | gnuplot -p

rm -f libad.so ad.o
${CC} -O0 -c $WARNINGS -g -fpic ad.c && ${CC} -shared -o libad.so ad.o &
# Example:
# gcc -L. -Wall -g -o test ad-test.c -lad -ltaylor -lmpfr
# ./test 7 2 1 >/tmp/ad-test.txt; diff --context=1 /tmp/ad-test.txt ad-test.txt

wait

${CC} -L. -Wall -o libad-test libad-test.c -lad -ltaylor -lmpfr

ls -lh --color *ad-* tsm-* lib*.so rk4-*

