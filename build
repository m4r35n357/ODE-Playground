#!/bin/sh
#
#  (c) 2018-2020 m4r35n357@gmail.com (Ian Smith), for licencing see the LICENCE file
#

WARNINGS='-pedantic -Wall -Wshadow -Wpointer-arith -Wcast-qual -Wstrict-prototypes -Wmissing-prototypes -Wextra -Wconversion'

CC='/usr/bin/musl-gcc -std=c99'
if [ x"$1" = x'clang' ]
then
    CC='/usr/bin/clang'
elif [ x"$1" = x'gcc' ]
then
    CC='/usr/bin/c99'
fi
${CC} --version

rm -f *.o *.so *.gch tsm-*[^.][^c]

build_symp () {
    name=$1
    ${CC} -O3 -DNDEBUG -static -o ${name}-static ${name}.c dual.c -lm -s
    ${CC} -O0 $WARNINGS -g -o ${name}-dbg ${name}.c dual.c -lm
}

for model in \
h-newton \
h-kerr
do
    rm -f ${model}-*
    echo " Building ${model}"
    build_symp ${model} &
done

build_tsm () {
    name=$1
    ${CC} -O3 -DNDEBUG -static -o ${name}-static ${name}.c taylor-ode.c -lm -s
    ${CC} -O0 $WARNINGS -g -o ${name}-dbg ${name}.c taylor-ode.c -lm
}

for model in \
tsm-bouali \
tsm-genesio-tesi \
tsm-halvorsen \
tsm-kom \
tsm-lorenz \
tsm-lotka-volterra \
tsm-rossler \
tsm-rucklidge \
tsm-rf \
tsm-sprott-minimal \
tsm-sprott-thomas \
tsm-thomas \
tsm-van-der-pol \
tsm-wimol-banlue \
tsm-yu-wang
do
    rm -f ${model}-*
    echo " Building ${model}"
    build_tsm ${model} &
done

echo " Building divergence"
${CC} -O3 $WARNINGS -o divergence divergence.c -lm -s &

echo " Building libode"
rm -f libtaylor.so taylor-ode.o
${CC} -O3 -DNDEBUG -c $WARNINGS -fpic taylor-ode.c && ${CC} -shared -o libode.so taylor-ode.o -s &
#  Example: musl-gcc -O3 -DNDEBUG -L. -Wall -Wextra -o test tsm-lorenz.c -lode -lm -s
#  Example: LD_LIBRARY_PATH=. ./test 15 10 .01 10000 -15.8 -17.48 35.64 10 28 8 3 | gnuplot -p -e "splot '<cat' with lines"

echo ""
wait
ls -lh --color tsm-* h-* lib*.so divergence
echo ""
